<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<title>ç‚ºäº†éŒ¢éŒ¢</title>

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#111827">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="ç‚ºäº†éŒ¢éŒ¢">

<style>
body{
  font-family: system-ui,-apple-system,"Segoe UI",Arial,sans-serif;
  background:#f6f7fb;
  margin:0;
  min-height:100vh;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:24px;
  overflow-x:hidden;
}
.card{
  width:min(820px,98vw);
  background:#fff;
  border-radius:16px;
  box-shadow:0 8px 24px rgba(0,0,0,.08);
  padding:18px;
}
h1{font-size:20px;margin:0 0 8px}
.hint{color:#555;font-size:13px;margin-bottom:14px;line-height:1.6}

.ringBoard{
  display:grid;
  grid-template-columns:96px 1fr 1fr 1fr 96px;
  grid-template-rows:56px 1fr 1fr 1fr 56px;
  gap:10px;
}

.ringBtn{
  border:0;border-radius:12px;
  padding:8px 6px;
  cursor:pointer;
  color:#fff;font-weight:800;
  box-shadow:0 6px 14px rgba(0,0,0,.18);
  white-space:pre-line;
}
.ringBtn:active{transform:translateY(1px)}
.bRow{background:#1f6feb}
.bCol{background:#10b981}
.bDiag{background:#6f42c1}

.gridWrap{
  grid-column:2/5;
  grid-row:2/5;
  background:#f1f3f9;
  border-radius:16px;
  padding:12px;
  display:grid;
  grid-template-columns:repeat(3,1fr);
  grid-template-rows:repeat(3,1fr);
  gap:10px;
  min-width:320px;
  min-height:320px;
}
.cell{
  background:#fff;
  border-radius:14px;
  display:flex;
  align-items:center;
  justify-content:center;
  position:relative;
  box-shadow:0 6px 14px rgba(0,0,0,.06);
}
.idx{
  position:absolute;
  top:8px;left:10px;
  font-size:11px;color:#888;
}
input{
  width:70%;
  height:55%;
  text-align:center;
  font-size:24px; /* >=16pxï¼ŒiOS ä¸æœƒè‡ªå‹•æ”¾å¤§ */
  border:1px solid #d8dbea;
  border-radius:12px;
  outline:none;
}

.ringBtn,.btn,input{touch-action:manipulation}

.actions{margin-top:14px;display:flex;gap:10px;flex-wrap:wrap}
.btn{
  border:0;border-radius:12px;
  padding:10px 12px;
  cursor:pointer;font-weight:800;
  background:#111827;color:#fff;
}
.btn.ghost{background:#e5e7eb;color:#111827}

.msg{
  margin-top:12px;
  background:#0b1220;color:#e5e7eb;
  border-radius:12px;
  padding:12px;
  font-size:13px;
  line-height:1.6;
  white-space:pre-wrap;
  min-height:130px;
}

/* æ‰‹æ©Ÿé©é…ï¼ˆä¿®æ­£ iPhone 13 è¶…å‡ºï¼‰ */
@media (max-width:430px){
  body{padding:10px;align-items:flex-start}
  .card{width:100%;padding:12px}
  .ringBoard{
    gap:8px;
    grid-template-columns:64px 1fr 1fr 1fr 64px;
    grid-template-rows:52px 1fr 1fr 1fr 52px;
  }
  .ringBtn{font-size:12px;padding:6px 4px}
  .gridWrap{
    min-width:0 !important;
    min-height:0 !important;
    width:100%;
    aspect-ratio:1/1;
    padding:10px;
    gap:8px;
  }
  input{font-size:20px}
  .msg{font-size:12px;min-height:105px}
}
</style>
</head>

<body>
<div class="card">
  <h1>ç‚ºäº†éŒ¢éŒ¢ ğŸ’°</h1>
  <div class="hint">
    å¤–åœˆæŒ‰éˆ•æœƒé¡¯ç¤ºã€Œå¯èƒ½åŠ ç¸½ã€ã€‚<br>
    ä¹Ÿå¯ä»¥æŒ‰ã€ŒæœŸæœ›å€¼æœ€é«˜å»ºè­°ã€â†’ æ¨è–¦ä½ è¦æŒ‰å“ªå€‹éµï¼ˆä¸»å°è§’/å‰¯å°è§’/åˆ—/æ¬„ï¼‰ã€‚
  </div>

  <div class="ringBoard" id="board">
    <div class="gridWrap" id="grid"></div>
  </div>

  <div class="actions">
    <button class="btn" id="btnBest">æœŸæœ›å€¼æœ€é«˜å»ºè­°</button>
    <button class="btn ghost" id="btnClear">æ¸…ç©º</button>
  </div>

  <div class="msg" id="msg">ç‚ºäº†éŒ¢éŒ¢ï¼Œè«‹è¼¸å…¥æ•¸å­—ã€‚</div>
</div>

<script>
const msgEl = document.getElementById("msg");
const msg = (t) => msgEl.textContent = t;

const boardEl = document.getElementById("board");
const gridEl  = document.getElementById("grid");
const inputs = [];

/* ===== ä½ çš„çé‡‘è¡¨ï¼šsum(6~24) => payout ===== */
const PAYOUT = {
  6:10000, 7:36, 8:720, 9:360, 10:80, 11:252, 12:108,
  13:72, 14:54, 15:180, 16:72, 17:180, 18:119, 19:36,
  20:306, 21:1080, 22:144, 23:1800, 24:360
};
const payoutOf = (sum) => (PAYOUT[sum] ?? 0);

/* ===== å»ºç«‹è¼¸å…¥æ ¼ï¼šåš´æ ¼ 1~9ã€ä¸å¯é‡è¤‡ï¼ˆå«è²¼ä¸Šï¼‰ ===== */
for(let i=1;i<=9;i++){
  const c = document.createElement("div"); c.className="cell";
  const idx = document.createElement("div"); idx.className="idx"; idx.textContent=i;

  const inp = document.createElement("input");
  inp.type="text";
  inp.inputMode="numeric";
  inp.pattern="[1-9]";
  inp.maxLength=1;
  inp.autocomplete="off";
  inp.spellcheck=false;

  inp.addEventListener("paste", (e) => {
    e.preventDefault();
    const t = (e.clipboardData.getData("text")||"");
    const m = t.match(/[1-9]/);
    inp.value = m ? m[0] : "";
    inp.dispatchEvent(new Event("input", {bubbles:true}));
  });

  inp.addEventListener("input", () => {
    const m = inp.value.match(/[1-9]/);
    inp.value = m ? m[0] : "";
    if(!inp.value){ msg("æ¸…ç©ºä¸€æ ¼"); return; }
    if(inputs.some(x => x !== inp && x.value === inp.value)){
      inp.value = "";
      msg("â— æ•¸å­—ä¸èƒ½é‡è¤‡ï¼ˆ1~9 æ¯å€‹åªèƒ½ç”¨ä¸€æ¬¡ï¼‰");
      return;
    }
    msg("è¼¸å…¥ï¼š" + inp.value);
  });

  c.append(idx, inp);
  gridEl.append(c);
  inputs.push(inp);
}

/* ===== ç·šå®šç¾©ï¼ˆä½ è¦çš„ 8 å€‹æŒ‰éµé¡å‹ï¼‰ ===== */
const rows = r => [(r-1)*3+1,(r-1)*3+2,(r-1)*3+3];
const cols = c => [c, c+3, c+6];
const diagMain = [1,5,9]; // ä¸»å°è§’
const diagAnti = [3,5,7]; // å‰¯å°è§’

const LINES = [
  { key:"ä¸»å°è§’", idxs: diagMain, cls:"bDiag" },
  { key:"æ¬„1",   idxs: cols(1),   cls:"bCol"  },
  { key:"æ¬„2",   idxs: cols(2),   cls:"bCol"  },
  { key:"æ¬„3",   idxs: cols(3),   cls:"bCol"  },
  { key:"å‰¯å°è§’", idxs: diagAnti, cls:"bDiag" },
  { key:"åˆ—1",   idxs: rows(1),   cls:"bRow"  },
  { key:"åˆ—2",   idxs: rows(2),   cls:"bRow"  },
  { key:"åˆ—3",   idxs: rows(3),   cls:"bRow"  }
];

/* ===== è®€ç›¤é¢ ===== */
function readBoard(){
  const b = Array(9).fill(null);
  for(let i=0;i<9;i++){
    const v = inputs[i].value.trim();
    if(v) b[i] = Number(v);
  }
  return b;
}

/* ===== è¨ˆç®—è©²ç·š sum ===== */
function lineSum(board, idxs){
  return idxs.reduce((acc, pos) => acc + (board[pos-1] ?? 0), 0);
}

/* ===== æšèˆ‰æ‰€æœ‰å¯èƒ½å®Œæˆå¡«æ³•ï¼ˆå›å‚³ iteratorï¼‰ ===== */
function enumerateCompletions(board){
  const used = new Set(board.filter(v => v !== null));
  const remaining = [];
  for(let d=1; d<=9; d++) if(!used.has(d)) remaining.push(d);

  const emptyPos = [];
  for(let i=0;i<9;i++) if(board[i] === null) emptyPos.push(i);

  // ç¸½æ•¸ = (n)!
  let total = 1;
  for(let k=2;k<=emptyPos.length;k++) total *= k;

  function* gen(posIdx, avail, cur){
    if(posIdx === emptyPos.length){
      yield cur;
      return;
    }
    const at = emptyPos[posIdx];
    for(let i=0;i<avail.length;i++){
      const d = avail[i];
      cur[at] = d;
      const nextAvail = avail.slice(0,i).concat(avail.slice(i+1));
      yield* gen(posIdx+1, nextAvail, cur);
      cur[at] = null;
    }
  }

  return { total, iter: () => gen(0, remaining, board.slice()) };
}

/* ===== å¯èƒ½åŠ ç¸½ï¼ˆåŸæœ¬åŠŸèƒ½ï¼‰æ”¹æˆã€Œå¸¶çé‡‘ã€é¡¯ç¤º ===== */
function possibleSumsWithPayout(board, idxs){
  const e = enumerateCompletions(board);
  const sums = new Set();

  for(const b of e.iter()){
    sums.add(lineSum(b, idxs));
  }
  const sorted = [...sums].sort((a,b)=>a-b);

  // åŒæ™‚é¡¯ç¤ºæœ‰çé‡‘çš„é …ç›®
  const withPay = sorted
    .filter(s => s >= 6 && s <= 24)
    .map(s => `${s}=${payoutOf(s)}`);

  return { total:e.total, sums: sorted, withPay };
}

/* ===== æœŸæœ›å€¼ EVï¼šåŸºæ–¼ã€Œæ‰€æœ‰å®Œæˆå¡«æ³•ç­‰æ©Ÿç‡ã€ ===== */
function expectedValue(board, idxs){
  const e = enumerateCompletions(board);

  let acc = 0;
  const counts = new Map(); // sum -> countï¼ˆç”¨ä¾†é¡¯ç¤ºä¸€äº›åˆ†ä½ˆï¼‰
  let checked = 0;

  for(const b of e.iter()){
    checked++;
    const s = lineSum(b, idxs);
    const p = payoutOf(s);
    acc += p;

    // è¨˜éŒ„ sum å‡ºç¾æ¬¡æ•¸ï¼ˆåªè¨˜ 6~24 ä»¥å…å¤ªé›œï¼‰
    if(s >= 6 && s <= 24){
      counts.set(s, (counts.get(s) || 0) + 1);
    }
  }

  const ev = acc / e.total;

  // å–å‡ºå‰å¹¾å€‹æœ€å¸¸å‡ºç¾çš„ sumï¼ˆ6~24ï¼‰
  const top = [...counts.entries()]
    .sort((a,b)=>b[1]-a[1])
    .slice(0, 6)
    .map(([s,c])=>`${s}Ã—${c}`);

  return { ev, total:e.total, checked, topSums: top };
}

/* ===== å¤–åœˆæŒ‰éˆ•ï¼ˆ16é¡†ï¼‰ ===== */
function addRingButton(row, col, text, cls, idxs, title){
  const btn = document.createElement("button");
  btn.className = `ringBtn ${cls}`;
  btn.style.gridRow = row;
  btn.style.gridColumn = col;
  btn.textContent = text;

  btn.addEventListener("click", () => {
    const board = readBoard();
    const res = possibleSumsWithPayout(board, idxs);

    msg(
      `${title}\n` +
      `å¯èƒ½åŠ ç¸½ï¼š${res.sums.join(", ")}\n\n` +
      (res.withPay.length
        ? `å…¶ä¸­æœ‰çé‡‘(6~24)ï¼š\n${res.withPay.join("ï¼Œ")}`
        : `å…¶ä¸­æ²’æœ‰è½åœ¨ 6~24 çš„çé‡‘å€é–“`)
    );
  });

  boardEl.appendChild(btn);
}

/* å°è§’ï¼ˆå››è§’å…©å…©å°æ‡‰ï¼‰ */
addRingButton(1,1, "ä¸»å°è§’", "bDiag", diagMain, "ä¸»å°è§’ï¼ˆ1,5,9ï¼‰");
addRingButton(5,5, "ä¸»å°è§’", "bDiag", diagMain, "ä¸»å°è§’ï¼ˆ1,5,9ï¼‰");
addRingButton(1,5, "å‰¯å°è§’", "bDiag", diagAnti, "å‰¯å°è§’ï¼ˆ3,5,7ï¼‰");
addRingButton(5,1, "å‰¯å°è§’", "bDiag", diagAnti, "å‰¯å°è§’ï¼ˆ3,5,7ï¼‰");

/* ä¸Šä¸‹ï¼šæ¬„1~3 */
for(let c=1;c<=3;c++){
  const idxs = cols(c);
  addRingButton(1, c+1, `æ¬„${c}`, "bCol", idxs, `æ¬„${c}ï¼ˆ${idxs.join(",")}ï¼‰`);
  addRingButton(5, c+1, `æ¬„${c}`, "bCol", idxs, `æ¬„${c}ï¼ˆ${idxs.join(",")}ï¼‰`);
}

/* å·¦å³ï¼šåˆ—1~3 */
for(let r=1;r<=3;r++){
  const idxs = rows(r);
  addRingButton(r+1, 1, `åˆ—${r}`, "bRow", idxs, `åˆ—${r}ï¼ˆ${idxs.join(",")}ï¼‰`);
  addRingButton(r+1, 5, `åˆ—${r}`, "bRow", idxs, `åˆ—${r}ï¼ˆ${idxs.join(",")}ï¼‰`);
}

/* ===== æœŸæœ›å€¼æœ€é«˜å»ºè­° ===== */
document.getElementById("btnBest").addEventListener("click", () => {
  const board = readBoard();
  const filledCount = board.filter(v => v !== null).length;

  // 9! = 362,880ï¼šæ‰‹æ©Ÿä»å¯ç®—ï¼Œä½†æˆ‘æé†’ä¸€ä¸‹
  // ä½ å¡«è¶Šå¤šï¼Œæœƒè¶Šå¿«
  const results = LINES.map(line => {
    const r = expectedValue(board, line.idxs);
    return { name: line.key, ev: r.ev, total: r.total, top: r.topSums };
  }).sort((a,b)=>b.ev-a.ev);

  const best = results[0];

  const linesText = results.map((x, i) =>
    `${i===0 ? "âœ…" : "  "} ${x.name}ï¼šEV=${Math.round(x.ev).toLocaleString()}ï¼ˆå®Œæˆå¡«æ³•${x.total}ç¨®ï¼‰` +
    (x.top.length ? `ï¼›å¸¸è¦‹sumï¼š${x.top.join(", ")}` : "")
  ).join("\n");

  msg(
    `ç›®å‰å·²å¡« ${filledCount} æ ¼\n` +
    `ğŸ‘‰ å»ºè­°æŒ‰ï¼š${best.name}\n` +
    `ï¼ˆæœŸæœ›å€¼ EV â‰ˆ ${Math.round(best.ev).toLocaleString()}ï¼‰\n\n` +
    `${linesText}`
  );
});

/* ===== æ¸…ç©º ===== */
document.getElementById("btnClear").addEventListener("click", () => {
  inputs.forEach(i => i.value = "");
  msg("å·²æ¸…ç©ºï¼Œé‡æ–°ç‚ºäº†éŒ¢éŒ¢ã€‚");
});

/* ===== PWAï¼šè¨»å†Š Service Worker ===== */
if("serviceWorker" in navigator){
  navigator.serviceWorker.register("./sw.js");
}
</script>
</body>
</html>
